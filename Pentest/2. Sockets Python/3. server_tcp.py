import socket


server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
    '''
    O servidor escuta uma porta esperando um cliente conecar
    Definir com método .bind((endereço_que_vai_escutar, porta))
    0.0.0.0 é o IP genérico. Se especificar algum só vai conectar se a requisição for dele.
    '''
    server.bind(("0.0.0.0", 4466))

    '''Método .listen(número_de_conexões_simultâneas) começa a ouvir'''
    server.listen(5)
    
    '''
    Método .accept() aguarda conexão de algum cliente
    Retorna tupla com ((socket, tupla com endereço e porta))
    '''
    print("Listening....")
    client_socket, address = server.accept()
    print("Conectado ao IP:", address[0])

    while True:
        '''usar socket para receber dados'''
        data = client_socket.recv(1024)
        print(data.decode())
        if data.decode() == "sair\n":
            break
        
        msg = input("Mensagem: ") + "\n"
        client_socket.send(msg.encode())
        if msg.decode() == "sair\n":
            break
    server.close()

except Exception as error:
    print("Erro no servidor TCP: ", error)

'''
Caso não esteja rodando por a porta estar ocupada, pode tentar identificar o programa ocupando e encerra-lo
Para listar quem ocupa a porta:
    $ sudo ss -lptn 'sport = :4466'
    $ sudo netstat -nlp | grep :4466
    $ sudo lsof -n -i :4466 | grep LISTEN

Para encerrar
    $ kill <pid> (pede encerramento)
    $ kill -9 <pid> (imediato e abrupto)
'''
